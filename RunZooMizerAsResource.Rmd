---
title: "Run Mizer with ZooMizer as a resource"
author: "Patrick Sykes"
date: "26/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Set up the model

Load in required libraries and functions:

```{r libraries}

library(mizer)
library(tidyverse)
library(assertthat)
source("ZooMizerResourceFunctions.R")
```

Now the data needed to run the model
```{r data}

groups <- read.csv("data/TestGroups_mizer.csv") #load in ZooMSS groups
groups <- groups[which(groups$Type == "Zooplankton"),] #just keep the zooplankton

ID <- 20  # pick a row to use of the environment data
input <- readRDS("data/enviro_test20.RDS")[ID,]

```

We now build the model:

```{r setup_params}

# fish_params <- NS_params  # or any other mizer params object
fish_params <- newMultispeciesParams(species_params = NS_species_params,
                                     interaction = inter,
                                     min_w_pp = 10^(-14.5),
                                     #gear_params = NS_species_params_gears
                                     kappa = 10^(input$phyto_int),
                                     lambda = 1-input$phyto_slope
                                     )

# fish_params <- newTraitParams(min_w_pp = 10^(-14.5), kappa = 10^(input$phyto_int), lambda = 2)

zoo_params <- newZooMizerParams(groups = groups, input = input, fish_params = fish_params)


fish_params <- fish_params %>% 
    setComponent(component = "zoo",
                 initial_value = zoo_params@initial_n,
                 dynamics_fun = "zoo_dynamics",
                 component_params = list(params = zoo_params)
                 ) %>% 
    setResource(resource_dynamics = "resource_zooMizer")

initialNResource(fish_params) <- resource_zooMizer(fish_params, fish_params@initial_n_other)

```

And run it:

```{r run}

sim <- project(fish_params, t_max = 5, dt = 0.1)
plot(sim)


```

Tuning etc

```{r}

#steady_fish <-  steady(fish_params)
tuned_erepro <- retune_erepro(fish_params)

tuned_sim <- project(tuned_erepro, t_max = 5, dt = 0.1)

```

```{r plots}
plotSpectra(sim, wlim = c(tuned_sim@params@w_full[1], 1000))
plotSpectra(tuned_sim, wlim = c(tuned_sim@params@w_full[1], 1000))

```
